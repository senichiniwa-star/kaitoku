<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁØâÂú∞Ë≤ùÂæ≥ Ê≥®ÊñáÁÆ°ÁêÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; }
        .flash { animation: flash 0.3s ease-out; }
        @keyframes flash {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #4ade80; }
            100% { transform: scale(1); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="app" class="p-4 md:p-6"></div>
    
    <!-- Â£≤‰∏äÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="editSalesModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Â£≤‰∏ä„Éá„Éº„ÇøÁ∑®ÈõÜ</h2>
                <button onclick="closeEditSalesModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            
            <div id="editSalesContent"></div>

            <div class="mt-6 flex gap-3">
                <button onclick="saveEditedSale()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    ‰øùÂ≠ò
                </button>
                <button onclick="deleteEditedSale()" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors">
                    ÂâäÈô§
                </button>
                <button onclick="closeEditSalesModal()" 
                    class="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold py-3 rounded-lg transition-colors">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuzBKMdD_2IQOWEMm9bK7bjEem3OTwrXE",
            authDomain: "kaitoku-32394.firebaseapp.com",
            databaseURL: "https://kaitoku-32394-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kaitoku-32394",
            storageBucket: "kaitoku-32394.firebasestorage.app",
            messagingSenderId: "166132839262",
            appId: "1:166132839262:web:128ce9ebe95b1c6bfa55cf"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const menuItems = [
            { id: 'course', name: 'Âü∫Êú¨„Ç≥„Éº„Çπ', price: 10000, category: 'course' },
            { id: 'crab', name: 'Ëüπ„Ç™„Éó„Ç∑„Éß„É≥', price: 3000, category: 'option' },
            { id: 1, name: '„ÅäÊ∞¥', price: 0, category: 'drink' },
            { id: 2, name: 'ÁÇ≠ÈÖ∏Ê∞¥', price: 0, category: 'drink' },
            { id: 3, name: '„ÅäËå∂', price: 0, category: 'drink' },
            { id: 4, name: '„Éè„Ç§„Éú„Éº„É´ÔºàÁîü„Éì„Éº„É´Ôºâ', price: 700, category: 'drink' },
            { id: 5, name: '„Ç¢„Çµ„ÉíÈªíÁîüÔºàÁì∂„Éì„Éº„É´Ôºâ', price: 700, category: 'drink' },
            { id: 6, name: '„Éè„Ç§„Éú„Éº„É´', price: 700, category: 'drink' },
            { id: 7, name: '„Ç¶„Ç§„Çπ„Ç≠„Éº „Ç∏„É£„ÉÉ„ÇØ„ÉÄ„Éã„Ç®„É´', price: 2500, category: 'drink' },
            { id: 8, name: '„Ç¶„Ç§„Çπ„Ç≠„Éº „Çµ„É≥„Éà„É™„ÉºËßí', price: 2500, category: 'drink' },
            { id: 9, name: 'ÁÑºÈÖéÔºàDAIYAMEÔºâ', price: 1200, category: 'drink' },
            { id: 10, name: 'Êó•Êú¨ÈÖíÔºàÈÖîÈØ®Ôºâ', price: 1200, category: 'drink' },
            { id: 11, name: 'Êó•Êú¨ÈÖíÔºàÊôØËôéÔºâ', price: 1200, category: 'drink' },
            { id: 12, name: 'Ëµ§„ÉØ„Ç§„É≥', price: 2000, category: 'drink' },
            { id: 13, name: 'ÁôΩ„ÉØ„Ç§„É≥', price: 2000, category: 'drink' },
            { id: 14, name: '„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ„ÄÄÂêÑÁ®Æ', price: 300, category: 'drink' },
            { id: 15, name: '„ÉØ„Ç§„É≥ÊåÅ„Å°Ëæº„Åø', price: 4000, category: 'drink' },
        ];

        let orders = {};
        let selectedSeat = 1;
        let flashingItem = null;
        let salesHistory = [];
        let reservations = [];
        let staffSchedule = {};
        let currentView = 'order';
        let todayDate = new Date().toISOString().split('T')[0];
        let editingSaleId = null;

        async function loadReservations() {
            try {
                const snapshot = await database.ref('reservations').once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    reservations = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                } else {
                    reservations = [];
                }
            } catch (e) {
                console.error('‰∫àÁ¥Ñ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }
        }

        async function loadStaffSchedule() {
            try {
                const snapshot = await database.ref('staffSchedule').once('value');
                if (snapshot.exists()) {
                    staffSchedule = snapshot.val();
                } else {
                    staffSchedule = {};
                }
            } catch (e) {
                console.error('„Çπ„Çø„ÉÉ„Éï„Çπ„Ç±„Ç∏„É•„Éº„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }
        }

        async function loadSalesData() {
            try {
                const snapshot = await database.ref('sales').once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    salesHistory = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                } else {
                    salesHistory = [];
                }
            } catch (e) {
                console.log('Â£≤‰∏ä„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }
        }

        async function saveSalesData() {
            try {
                const salesObj = {};
                salesHistory.forEach(sale => {
                    salesObj[sale.id] = { ...sale };
                    delete salesObj[sale.id].id;
                });
                await database.ref('sales').set(salesObj);
            } catch (e) {
                console.error('Â£≤‰∏ä„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', e);
            }
        }

        function getTodayReservations() {
            return reservations.filter(r => r.date === todayDate);
        }

        function getTodayStaff() {
            return staffSchedule[todayDate] || 'Êú™Ë®≠ÂÆö';
        }

        function initializeOrdersFromReservations() {
            const todayReservations = getTodayReservations();
            let seatCounter = 1;
            
            todayReservations.forEach(reservation => {
                if (!orders[seatCounter]) {
                    orders[seatCounter] = [];
                    // Âü∫Êú¨„Ç≥„Éº„Çπ„Çí‰∫∫Êï∞ÂàÜËøΩÂä†
                    for (let i = 0; i < reservation.seats; i++) {
                        orders[seatCounter].push({
                            ...menuItems.find(m => m.id === 'course'),
                            orderId: Date.now() + i,
                            reservationName: reservation.name
                        });
                    }
                }
                seatCounter++;
            });
        }

        function addOrder(item) {
            if (!orders[selectedSeat]) orders[selectedSeat] = [];
            orders[selectedSeat].push({ ...item, orderId: Date.now() });
            
            flashingItem = item.id;
            setTimeout(() => {
                flashingItem = null;
                render();
            }, 300);
            
            render();
        }

        function removeOrder(seat, orderId) {
            orders[seat] = orders[seat].filter(o => o.orderId !== orderId);
            if (orders[seat].length === 0) delete orders[seat];
            render();
        }

        function calculateSeatTotal(seat) {
            if (!orders[seat]) return 0;
            return orders[seat].reduce((sum, o) => sum + o.price, 0);
        }

        function calculateAllTotal() {
            return Object.keys(orders).reduce((sum, seat) => sum + calculateSeatTotal(parseInt(seat)), 0);
        }

        async function checkoutSeat(seat) {
            if (orders[seat] && orders[seat].length > 0) {
                const total = calculateSeatTotal(seat);
                const staff = getTodayStaff();
                
                const saleRecord = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    date: todayDate,
                    time: new Date().toLocaleTimeString('ja-JP'),
                    seat: seat,
                    staff: staff,
                    items: orders[seat].map(o => ({ name: o.name, price: o.price })),
                    total: total
                };
                salesHistory.push(saleRecord);
                await saveSalesData();
                
                alert(`Â∏≠${seat}Áï™Ôºö„Åä‰ºöË®à ¬•${total.toLocaleString()}\nÊãÖÂΩìÔºö${staff}\n\nÂ£≤‰∏ä„Éá„Éº„Çø„Å´Ë®òÈå≤„Åó„Åæ„Åó„Åü`);
                delete orders[seat];
                render();
            }
        }

        async function checkoutMultiple() {
            const selectedSeats = [];
            document.querySelectorAll('input[name="selectSeat"]:checked').forEach(cb => {
                selectedSeats.push(parseInt(cb.value));
            });

            if (selectedSeats.length === 0) {
                alert('‰ºöË®à„Åô„ÇãÂ∏≠„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const staff = getTodayStaff();
            
            for (const seat of selectedSeats) {
                if (orders[seat] && orders[seat].length > 0) {
                    const total = calculateSeatTotal(seat);
                    const saleRecord = {
                        id: Date.now().toString() + '-' + seat,
                        timestamp: new Date().toISOString(),
                        date: todayDate,
                        time: new Date().toLocaleTimeString('ja-JP'),
                        seat: seat,
                        staff: staff,
                        items: orders[seat].map(o => ({ name: o.name, price: o.price })),
                        total: total
                    };
                    salesHistory.push(saleRecord);
                }
            }

            await saveSalesData();
            
            const totalAmount = selectedSeats.reduce((sum, seat) => sum + calculateSeatTotal(seat), 0);
            alert(`Â∏≠${selectedSeats.join(', ')}Áï™Ôºö„Åæ„Å®„ÇÅ„Å¶„Åä‰ºöË®à ¬•${totalAmount.toLocaleString()}\nÊãÖÂΩìÔºö${staff}\n\nÂ£≤‰∏ä„Éá„Éº„Çø„Å´Ë®òÈå≤„Åó„Åæ„Åó„Åü`);
            
            selectedSeats.forEach(seat => delete orders[seat]);
            render();
        }

        function openEditSalesModal(sale) {
            editingSaleId = sale.id;
            const modal = document.getElementById('editSalesModal');
            const content = document.getElementById('editSalesContent');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Êó•‰ªò</label>
                        <input type="date" id="editDate" value="${sale.date}"
                            class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Â∏≠Áï™Âè∑</label>
                        <input type="number" id="editSeat" value="${sale.seat}" min="1" max="8"
                            class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï</label>
                        <select id="editStaff" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="‰ªô‰∏Ä" ${sale.staff === '‰ªô‰∏Ä' ? 'selected' : ''}>‰ªô‰∏Ä</option>
                            <option value="Âæ≥Â§öÈÉé" ${sale.staff === 'Âæ≥Â§öÈÉé' ? 'selected' : ''}>Âæ≥Â§öÈÉé</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ê≥®ÊñáÂÜÖÂÆπ</label>
                        <div class="space-y-2" id="editItems">
                            ${sale.items.map((item, index) => `
                                <div class="flex gap-2">
                                    <input type="text" value="${item.name}" 
                                        class="flex-1 px-3 py-2 border-2 border-slate-300 rounded-lg" 
                                        data-index="${index}" data-field="name">
                                    <input type="number" value="${item.price}" 
                                        class="w-32 px-3 py-2 border-2 border-slate-300 rounded-lg" 
                                        data-index="${index}" data-field="price">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ÂêàË®àÈáëÈ°ç</label>
                        <input type="number" id="editTotal" value="${sale.total}"
                            class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeEditSalesModal() {
            const modal = document.getElementById('editSalesModal');
            modal.classList.remove('show');
            editingSaleId = null;
        }

        async function saveEditedSale() {
            const sale = salesHistory.find(s => s.id === editingSaleId);
            if (!sale) return;

            sale.date = document.getElementById('editDate').value;
            sale.seat = parseInt(document.getElementById('editSeat').value);
            sale.staff = document.getElementById('editStaff').value;
            sale.total = parseInt(document.getElementById('editTotal').value);
            
            sale.items = [];
            document.querySelectorAll('#editItems input[data-field="name"]').forEach((input, index) => {
                const priceInput = document.querySelector(`#editItems input[data-index="${index}"][data-field="price"]`);
                sale.items.push({
                    name: input.value,
                    price: parseInt(priceInput.value)
                });
            });

            await saveSalesData();
            closeEditSalesModal();
            render();
            alert('Â£≤‰∏ä„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
        }

        async function deleteEditedSale() {
            if (confirm('„Åì„ÅÆÂ£≤‰∏ä„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                salesHistory = salesHistory.filter(s => s.id !== editingSaleId);
                await saveSalesData();
                closeEditSalesModal();
                render();
                alert('Â£≤‰∏ä„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            }
        }

        async function clearSalesData() {
            if (confirm('Êú¨ÂΩì„Å´Â£≤‰∏ä„Éá„Éº„Çø„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                salesHistory = [];
                await database.ref('sales').remove();
                alert('Â£≤‰∏ä„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                render();
            }
        }

        function getMonthlyStats() {
            const stats = {};
            
            salesHistory.forEach(sale => {
                const month = sale.date.substring(0, 7);
                const staff = sale.staff || 'Êú™Ë®≠ÂÆö';
                
                if (!stats[month]) {
                    stats[month] = {
                        total: 0,
                        count: 0,
                        staff: { '‰ªô‰∏Ä': { total: 0, days: new Set() }, 'Âæ≥Â§öÈÉé': { total: 0, days: new Set() } }
                    };
                }
                
                stats[month].total += sale.total;
                stats[month].count++;
                
                if (staff === '‰ªô‰∏Ä' || staff === 'Âæ≥Â§öÈÉé') {
                    stats[month].staff[staff].total += sale.total;
                    stats[month].staff[staff].days.add(sale.date);
                }
            });
            
            // Set„Çí„Çµ„Ç§„Ç∫„Å´Â§âÊèõ
            Object.keys(stats).forEach(month => {
                stats[month].staff['‰ªô‰∏Ä'].days = stats[month].staff['‰ªô‰∏Ä'].days.size;
                stats[month].staff['Âæ≥Â§öÈÉé'].days = stats[month].staff['Âæ≥Â§öÈÉé'].days.size;
            });
            
            return stats;
        }

        function downloadCSV() {
            if (salesHistory.length === 0) {
                alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„ÇãÂ£≤‰∏ä„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            let csv = 'Êó•‰ªò,ÊôÇÈñì,Â∏≠Áï™Âè∑,ÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï,ÂïÜÂìÅÂêç,Âçò‰æ°,ÂêàË®àÈáëÈ°ç\n';
            
            salesHistory.forEach(sale => {
                sale.items.forEach((item, index) => {
                    if (index === 0) {
                        csv += `"${sale.date}","${sale.time}","${sale.seat}","${sale.staff}","${item.name}","¬•${item.price}","¬•${sale.total}"\n`;
                    } else {
                        csv += `"","","","","${item.name}","¬•${item.price}",""\n`;
                    }
                });
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            const today = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `ÁØâÂú∞Ë≤ùÂæ≥_Â£≤‰∏ä„Éá„Éº„Çø_${today}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
        }

        window.clearSalesData = clearSalesData;
        window.downloadCSV = downloadCSV;
        window.openEditSalesModal = openEditSalesModal;
        window.closeEditSalesModal = closeEditSalesModal;
        window.saveEditedSale = saveEditedSale;
        window.deleteEditedSale = deleteEditedSale;

        function renderAnalytics() {
            const monthlyStats = getMonthlyStats();
            const sortedMonths = Object.keys(monthlyStats).sort().reverse();

            return `
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4 md:mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Â£≤‰∏äÂàÜÊûê</h1>
                                <p class="text-slate-600">„Éá„Éº„ÇøÊï∞Ôºö${salesHistory.length}‰ª∂</p>
                            </div>
                            <button onclick="currentView='order'; render();"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg">
                                Ê≥®ÊñáÁîªÈù¢„Å∏
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        ${sortedMonths.map(month => {
                            const stat = monthlyStats[month];
                            return `
                                <div class="bg-white rounded-lg shadow-lg p-6">
                                    <h2 class="text-2xl font-bold text-slate-800 mb-4">${month}</h2>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div class="bg-blue-50 rounded-lg p-4">
                                            <h3 class="font-bold text-lg mb-3 text-blue-800">‰ªô‰∏Ä</h3>
                                            <div class="space-y-2">
                                                <div class="flex justify-between">
                                                    <span>Â£≤‰∏ä</span>
                                                    <span class="font-bold text-blue-600">¬•${stat.staff['‰ªô‰∏Ä'].total.toLocaleString()}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Âá∫Âã§Êó•Êï∞</span>
                                                    <span class="font-bold text-blue-600">${stat.staff['‰ªô‰∏Ä'].days}Êó•</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-green-50 rounded-lg p-4">
                                            <h3 class="font-bold text-lg mb-3 text-green-800">Âæ≥Â§öÈÉé</h3>
                                            <div class="space-y-2">
                                                <div class="flex justify-between">
                                                    <span>Â£≤‰∏ä</span>
                                                    <span class="font-bold text-green-600">¬•${stat.staff['Âæ≥Â§öÈÉé'].total.toLocaleString()}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Âá∫Âã§Êó•Êï∞</span>
                                                    <span class="font-bold text-green-600">${stat.staff['Âæ≥Â§öÈÉé'].days}Êó•</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="border-t-2 border-slate-200 pt-4">
                                        <div class="flex justify-between text-lg">
                                            <span class="font-bold">ÊúàÊ¨°ÂêàË®à</span>
                                            <span class="font-bold text-slate-800">¬•${stat.total.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mt-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Â£≤‰∏äÂ±•Ê≠¥ÔºàÊúÄÊñ∞20‰ª∂Ôºâ</h2>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${salesHistory.slice(-20).reverse().map(sale => `
                                <div onclick="openEditSalesModal(${JSON.stringify(sale).replace(/"/g, '&quot;')})"
                                    class="border border-slate-200 rounded-lg p-3 cursor-pointer hover:bg-slate-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="text-sm text-slate-600">
                                            ${sale.date} ${sale.time} - Â∏≠${sale.seat}Áï™ - ${sale.staff}
                                        </div>
                                        <div class="font-bold text-blue-600">¬•${sale.total.toLocaleString()}</div>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        ${sale.items.map(item => item.name).join(', ')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mt-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                        <div class="space-y-3">
                            <button onclick="downloadCSV()"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 rounded-lg w-full text-lg">
                                üì• Â£≤‰∏ä„Éá„Éº„Çø„ÇíCSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            </button>
                            <button onclick="clearSalesData()"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-3 rounded-lg w-full text-lg">
                                üóëÔ∏è Â£≤‰∏ä„Éá„Éº„Çø„ÇíÂÖ®„Å¶ÂâäÈô§
                            </button>
                        </div>
                        <p class="text-sm text-slate-500 mt-2">‚ÄªÂâäÈô§„Åó„Åü„Éá„Éº„Çø„ÅØÂæ©ÂÖÉ„Åß„Åç„Åæ„Åõ„Çì</p>
                    </div>
                </div>
            `;
        }

        function renderOrder() {
            const todayReservations = getTodayReservations();
            const todayStaff = getTodayStaff();

            return `
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4 md:mb-6">
                        <div class="flex items-center justify-between flex-wrap gap-3">
                            <div>
                                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">ÁØâÂú∞Ë≤ùÂæ≥</h1>
                                <p class="text-slate-600">Ê≥®ÊñáÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</p>
                                <p class="text-sm text-slate-500 mt-1">Êó•‰ªò: ${todayDate} / ÊãÖÂΩì: ${todayStaff}</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="currentView='analytics'; render();"
                                    class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg">
                                    üìä Â£≤‰∏äÂàÜÊûê
                                </button>
                                <a href="index.html"
                                    class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-4 py-2 rounded-lg">
                                    ‚Üê „Éà„ÉÉ„Éó„Å∏
                                </a>
                            </div>
                        </div>
                    </div>

                    ${todayReservations.length === 0 ? `
                        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 mb-6">
                            <p class="text-yellow-800 font-bold">‚ö†Ô∏è Êú¨Êó•„ÅÆ‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                            <p class="text-yellow-700 text-sm mt-2">‰∫àÁ¥ÑÁÆ°ÁêÜÁîªÈù¢„Åß‰∫àÁ¥Ñ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="lg:col-span-2 space-y-4 md:space-y-6">
                            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                                <h2 class="text-lg md:text-xl font-bold text-slate-800 mb-4">Â∏≠„ÇíÈÅ∏Êäû</h2>
                                <div class="grid grid-cols-4 gap-2 md:gap-3">
                                    ${[1,2,3,4,5,6,7,8].map(seat => `
                                        <button onclick="selectedSeat=${seat}; render();" 
                                            class="p-3 md:p-4 rounded-lg font-bold text-base md:text-lg transition-all ${
                                                selectedSeat === seat
                                                    ? 'bg-blue-600 text-white shadow-lg scale-105'
                                                    : orders[seat]?.length > 0
                                                    ? 'bg-amber-100 text-amber-800 hover:bg-amber-200'
                                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                            }">
                                            ${seat}Áï™
                                            ${orders[seat]?.length > 0 ? `<div class="text-xs mt-1">(${orders[seat].length}ÂìÅ)</div>` : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                                <h2 class="text-lg md:text-xl font-bold text-slate-800 mb-4">
                                    „É°„Éã„É•„ÉºÔºàÂ∏≠${selectedSeat}Áï™Ôºâ
                                </h2>
                                
                                <div class="mb-4">
                                    <h3 class="font-bold text-slate-700 mb-2">„Ç≥„Éº„Çπ„Éª„Ç™„Éó„Ç∑„Éß„É≥</h3>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${menuItems.filter(m => m.category === 'course' || m.category === 'option').map(item => `
                                            <button onclick="addOrder(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                                                class="flex flex-col items-start p-3 rounded-lg transition-all border-2 active:scale-95 ${
                                                    flashingItem === item.id
                                                        ? 'bg-green-400 border-green-500'
                                                        : 'bg-slate-50 hover:bg-blue-50 border-transparent hover:border-blue-300'
                                                }">
                                                <span class="font-medium text-sm ${
                                                    flashingItem === item.id ? 'text-white' : 'text-slate-800'
                                                }">
                                                    ${item.name}
                                                </span>
                                                <span class="font-bold text-base mt-1 ${
                                                    flashingItem === item.id ? 'text-white' : 'text-blue-600'
                                                }">
                                                    ¬•${item.price.toLocaleString()}
                                                </span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div>
                                    <h3 class="font-bold text-slate-700 mb-2">„Éâ„É™„É≥„ÇØ</h3>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                        ${menuItems.filter(m => m.category === 'drink').map(item => `
                                            <button onclick="addOrder(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                                                class="flex flex-col items-start p-2 rounded-lg transition-all border-2 active:scale-95 ${
                                                    flashingItem === item.id
                                                        ? 'bg-green-400 border-green-500'
                                                        : 'bg-slate-50 hover:bg-blue-50 border-transparent hover:border-blue-300'
                                                }">
                                                <span class="font-medium text-xs ${
                                                    flashingItem === item.id ? 'text-white' : 'text-slate-800'
                                                }">
                                                    ${item.name}
                                                </span>
                                                <span class="font-bold text-sm mt-1 ${
                                                    flashingItem === item.id ? 'text-white' : 'text-blue-600'
                                                }">
                                                    ${item.price === 0 ? 'ÁÑ°Êñô' : `¬•${item.price.toLocaleString()}`}
                                                </span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 md:space-y-6">
                            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                                <h2 class="text-lg md:text-xl font-bold text-slate-800 mb-4">ÁèæÂú®„ÅÆÊ≥®Êñá</h2>
                                <div class="space-y-4 max-h-96 overflow-y-auto">
                                    ${Object.keys(orders).sort((a,b) => a-b).map(seat => {
                                        const seatOrders = orders[seat];
                                        if (!seatOrders || seatOrders.length === 0) return '';
                                        return `
                                            <div class="border-2 border-slate-200 rounded-lg p-3 md:p-4">
                                                <div class="flex items-center justify-between mb-3">
                                                    <div class="flex items-center gap-2">
                                                        <input type="checkbox" name="selectSeat" value="${seat}" 
                                                            class="w-5 h-5">
                                                        <h3 class="font-bold text-slate-800">Â∏≠${seat}Áï™</h3>
                                                    </div>
                                                    <span class="font-bold text-blue-600">
                                                        ¬•${calculateSeatTotal(parseInt(seat)).toLocaleString()}
                                                    </span>
                                                </div>
                                                <div class="space-y-2">
                                                    ${seatOrders.map(order => `
                                                        <div class="flex items-center justify-between text-sm bg-slate-50 p-2 rounded">
                                                            <span class="text-slate-700">${order.name}</span>
                                                            <div class="flex items-center gap-2">
                                                                <span class="text-slate-600">
                                                                    ${order.price === 0 ? 'ÁÑ°Êñô' : `¬•${order.price.toLocaleString()}`}
                                                                </span>
                                                                <button onclick="removeOrder(${seat}, ${order.orderId})"
                                                                    class="text-red-500 hover:text-red-700 text-xl">
                                                                    √ó
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                                <button onclick="checkoutSeat(${seat})"
                                                    class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white font-medium py-2 rounded-lg transition-colors">
                                                    üí∞ ÂÄãÂà•‰ºöË®à
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            ${calculateAllTotal() > 0 ? `
                                <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg shadow-lg p-4 md:p-6 text-white">
                                    <h2 class="text-lg md:text-xl font-bold mb-4">„Åæ„Å®„ÇÅ„Å¶‰ºöË®à</h2>
                                    <div class="text-3xl md:text-4xl font-bold mb-4">
                                        ¬•${calculateAllTotal().toLocaleString()}
                                    </div>
                                    <button onclick="checkoutMultiple()"
                                        class="w-full bg-white text-blue-700 font-bold py-2 md:py-3 rounded-lg hover:bg-blue-50 transition-colors">
                                        üë• ÈÅ∏Êäû„Åó„ÅüÂ∏≠„Çí„Åæ„Å®„ÇÅ„Å¶‰ºöË®à
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = currentView === 'analytics' ? renderAnalytics() : renderOrder();
        }

        (async () => {
            await loadReservations();
            await loadStaffSchedule();
            await loadSalesData();
            
            initializeOrdersFromReservations();
            
            database.ref('sales').on('value', async () => {
                await loadSalesData();
                if (currentView === 'analytics') render();
            });
            
            render();
        })();
    </script>
</body>
</html>
