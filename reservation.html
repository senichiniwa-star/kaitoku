<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯‰åœ°è²å¾³ äºˆç´„ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="app" class="p-4 md:p-6"></div>

    <!-- äºˆç´„è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reservationModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-8">
            <div class="flex items-center justify-between mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-slate-800">äºˆç´„è¿½åŠ </h2>
                <button onclick="closeReservationModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">äºˆç´„æ—¥</label>
                    <input type="date" id="reservationDate" 
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">äºˆç´„è€…</label>
                    <select id="reservationName" 
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">äººæ•°</label>
                    <input type="number" id="reservationSeats" min="1" max="8" value="2"
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-slate-500 mt-1">â€»æœ€å¤§8åã¾ã§</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="reservationNotes" rows="3"
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="saveReservation()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    ä¿å­˜
                </button>
                <button onclick="closeReservationModal()" 
                    class="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold py-3 rounded-lg transition-colors">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
            
            <button id="deleteReservationButton" onclick="deleteReservation()" 
                class="w-full mt-3 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition-colors hidden">
                ğŸ—‘ï¸ ã“ã®äºˆç´„ã‚’å‰Šé™¤
            </button>
        </div>
    </div>

    <!-- äºˆç´„è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="customerModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">äºˆç´„è€…ç®¡ç†</h2>
                <button onclick="closeCustomerModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                <h3 class="font-bold text-slate-700 mb-3">æ–°ã—ã„äºˆç´„è€…ã‚’è¿½åŠ </h3>
                <div class="flex gap-2">
                    <input type="text" id="newCustomerName" placeholder="äºˆç´„è€…å"
                        class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <button onclick="addCustomer()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded-lg transition-colors">
                        è¿½åŠ 
                    </button>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-slate-700 mb-3">äºˆç´„è€…ãƒªã‚¹ãƒˆ</h3>
                <div id="customerList" class="space-y-2"></div>
            </div>

            <div class="mt-6">
                <button onclick="closeCustomerModal()"
                    class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition-colors">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- äºˆç´„åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="analyticsModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">äºˆç´„çŠ¶æ³åˆ†æ</h2>
                <button onclick="closeAnalyticsModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <div id="analyticsContent"></div>

            <div class="mt-6 flex gap-3">
                <button onclick="downloadReservationCSV()"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
                <button onclick="closeAnalyticsModal()"
                    class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition-colors">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuzBKMdD_2IQOWEMm9bK7bjEem3OTwrXE",
            authDomain: "kaitoku-32394.firebaseapp.com",
            databaseURL: "https://kaitoku-32394-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kaitoku-32394",
            storageBucket: "kaitoku-32394.firebasestorage.app",
            messagingSenderId: "166132839262",
            appId: "1:166132839262:web:128ce9ebe95b1c6bfa55cf"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const DEFAULT_CUSTOMERS = [
            'æ¤å', 'è±Šåœ‹', 'å‘‚', 'åŠ è—¤', 'ä¸¹ç¾½', 'å°æ—©å·', 
            'çŸ³ç”°', 'ç¨®è°·', 'å±±æ‘', 'å¤§å³¶', 'èµ¤å·', 'å¸‚å ´', 'ãƒãƒ¼ã‚¯'
        ];

        const COLOR_PALETTE = [
            'bg-blue-100 border-blue-400 text-blue-900',
            'bg-green-100 border-green-400 text-green-900',
            'bg-purple-100 border-purple-400 text-purple-900',
            'bg-pink-100 border-pink-400 text-pink-900',
            'bg-yellow-100 border-yellow-400 text-yellow-900',
            'bg-indigo-100 border-indigo-400 text-indigo-900',
            'bg-red-100 border-red-400 text-red-900',
            'bg-orange-100 border-orange-400 text-orange-900',
            'bg-teal-100 border-teal-400 text-teal-900',
            'bg-cyan-100 border-cyan-400 text-cyan-900',
            'bg-lime-100 border-lime-400 text-lime-900',
            'bg-emerald-100 border-emerald-400 text-emerald-900',
            'bg-violet-100 border-violet-400 text-violet-900',
            'bg-fuchsia-100 border-fuchsia-400 text-fuchsia-900',
            'bg-rose-100 border-rose-400 text-rose-900',
            'bg-sky-100 border-sky-400 text-sky-900',
            'bg-amber-100 border-amber-400 text-amber-900'
        ];

        let reservations = [];
        let customers = [];
        let customerColors = {};
        let currentMonth = new Date(2026, 0, 1);
        let editingReservationId = null;

        async function initializeCustomers() {
            try {
                const snapshot = await database.ref('customers').once('value');
                if (snapshot.exists()) {
                    customers = snapshot.val();
                } else {
                    customers = [...DEFAULT_CUSTOMERS];
                    await database.ref('customers').set(customers);
                }
                
                customers.forEach((name, index) => {
                    if (!customerColors[name]) {
                        customerColors[name] = COLOR_PALETTE[index % COLOR_PALETTE.length];
                    }
                });
            } catch (e) {
                console.error('äºˆç´„è€…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                customers = [...DEFAULT_CUSTOMERS];
            }
        }

        async function addCustomer() {
            const input = document.getElementById('newCustomerName');
            const name = input.value.trim();
            
            if (!name) {
                alert('äºˆç´„è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (customers.includes(name)) {
                alert('æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äºˆç´„è€…ã§ã™');
                return;
            }
            
            customers.push(name);
            customerColors[name] = COLOR_PALETTE[customers.length % COLOR_PALETTE.length];
            await database.ref('customers').set(customers);
            input.value = '';
            renderCustomerModal();
            updateReservationNameSelect();
        }

        async function deleteCustomer(name) {
            if (confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®äºˆç´„è€…ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“`)) {
                customers = customers.filter(c => c !== name);
                delete customerColors[name];
                await database.ref('customers').set(customers);
                renderCustomerModal();
                updateReservationNameSelect();
            }
        }

        function openCustomerModal() {
            const modal = document.getElementById('customerModal');
            renderCustomerModal();
            modal.classList.add('show');
        }

        function closeCustomerModal() {
            const modal = document.getElementById('customerModal');
            modal.classList.remove('show');
            render();
        }

        function renderCustomerModal() {
            const list = document.getElementById('customerList');
            list.innerHTML = customers.map(name => `
                <div class="flex items-center justify-between p-3 ${customerColors[name]} rounded-lg border-2">
                    <span class="font-bold">${name}</span>
                    <button onclick="deleteCustomer('${name}')" 
                        class="text-red-600 hover:text-red-800 font-bold">
                        å‰Šé™¤
                    </button>
                </div>
            `).join('');
        }

        function updateReservationNameSelect() {
            const select = document.getElementById('reservationName');
            const currentValue = select.value;
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + 
                customers.map(name => `<option value="${name}">${name}</option>`).join('');
            if (currentValue && customers.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        async function loadReservations() {
            try {
                const snapshot = await database.ref('reservations').once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    reservations = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                } else {
                    reservations = [];
                }
            } catch (e) {
                console.error('äºˆç´„ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        function changeMonth(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            render();
        }

        function openReservationModal(date = null, reservation = null) {
            const modal = document.getElementById('reservationModal');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteReservationButton');

            updateReservationNameSelect();

            if (reservation) {
                title.textContent = 'äºˆç´„ç·¨é›†';
                document.getElementById('reservationDate').value = reservation.date;
                document.getElementById('reservationName').value = reservation.name;
                document.getElementById('reservationSeats').value = reservation.seats;
                document.getElementById('reservationNotes').value = reservation.notes || '';
                deleteBtn.classList.remove('hidden');
                editingReservationId = reservation.id;
            } else {
                title.textContent = 'äºˆç´„è¿½åŠ ';
                document.getElementById('reservationDate').value = date || '';
                document.getElementById('reservationName').value = '';
                document.getElementById('reservationSeats').value = '2';
                document.getElementById('reservationNotes').value = '';
                deleteBtn.classList.add('hidden');
                editingReservationId = null;
            }

            modal.classList.add('show');
        }

        function closeReservationModal() {
            const modal = document.getElementById('reservationModal');
            modal.classList.remove('show');
            editingReservationId = null;
        }

        async function saveReservation() {
            const date = document.getElementById('reservationDate').value;
            const name = document.getElementById('reservationName').value;
            const seats = parseInt(document.getElementById('reservationSeats').value);
            const notes = document.getElementById('reservationNotes').value;

            if (!date || !name || !seats) {
                alert('æ—¥ä»˜ã€äºˆç´„è€…ã€äººæ•°ã¯å¿…é ˆã§ã™');
                return;
            }

            const sameDay = reservations.filter(r => r.date === date && r.id !== editingReservationId);
            const totalSeats = sameDay.reduce((sum, r) => sum + r.seats, 0) + seats;
            
            if (sameDay.length >= 2) {
                alert('åŒã˜æ—¥ã«æœ€å¤§2çµ„ã¾ã§äºˆç´„å¯èƒ½ã§ã™');
                return;
            }
            
            if (totalSeats > 8) {
                alert(`å¸­æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆä½¿ç”¨å¯èƒ½: ${8 - (totalSeats - seats)}å¸­ï¼‰`);
                return;
            }

            try {
                if (editingReservationId) {
                    await database.ref('reservations/' + editingReservationId).set({ date, name, seats, notes });
                } else {
                    const newRef = database.ref('reservations').push();
                    await newRef.set({ date, name, seats, notes });
                }
                
                await loadReservations();
                closeReservationModal();
                render();
            } catch (e) {
                console.error('äºˆç´„ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                alert('äºˆç´„ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function deleteReservation() {
            if (!editingReservationId) return;
            
            if (confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await database.ref('reservations/' + editingReservationId).remove();
                    await loadReservations();
                    closeReservationModal();
                    render();
                } catch (e) {
                    console.error('äºˆç´„å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
                    alert('äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }

        function openAnalyticsModal() {
            const modal = document.getElementById('analyticsModal');
            renderAnalytics();
            modal.classList.add('show');
        }

        function closeAnalyticsModal() {
            const modal = document.getElementById('analyticsModal');
            modal.classList.remove('show');
        }

        function renderAnalytics() {
            const monthlyStats = {};
            const customerStats = {};
            
            reservations.forEach(r => {
                const month = r.date.substring(0, 7);
                
                if (!monthlyStats[month]) {
                    monthlyStats[month] = { count: 0, seats: 0, customers: {} };
                }
                monthlyStats[month].count++;
                monthlyStats[month].seats += r.seats;
                
                if (!monthlyStats[month].customers[r.name]) {
                    monthlyStats[month].customers[r.name] = { count: 0, seats: 0 };
                }
                monthlyStats[month].customers[r.name].count++;
                monthlyStats[month].customers[r.name].seats += r.seats;
                
                if (!customerStats[r.name]) {
                    customerStats[r.name] = { count: 0, seats: 0 };
                }
                customerStats[r.name].count++;
                customerStats[r.name].seats += r.seats;
            });

            const sortedMonths = Object.keys(monthlyStats).sort().reverse();
            const sortedCustomers = Object.entries(customerStats).sort((a, b) => b[1].count - a[1].count);

            const content = document.getElementById('analyticsContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-2">å…¨ä½“ã‚µãƒãƒªãƒ¼</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-slate-600">ç·äºˆç´„æ•°</div>
                                <div class="text-2xl font-bold text-blue-600">${reservations.length}ä»¶</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-600">ç·äººæ•°</div>
                                <div class="text-2xl font-bold text-blue-600">${reservations.reduce((sum, r) => sum + r.seats, 0)}å</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-3">äºˆç´„è€…åˆ¥é›†è¨ˆ</h3>
                        <div class="space-y-2">
                            ${sortedCustomers.map(([name, data]) => `
                                <div class="flex items-center justify-between p-3 ${customerColors[name]} rounded-lg border-2">
                                    <span class="font-bold">${name}</span>
                                    <div class="text-right">
                                        <div class="font-bold">${data.count}å› / ${data.seats}å</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-3">æœˆåˆ¥é›†è¨ˆ</h3>
                        <div class="space-y-4">
                            ${sortedMonths.map(month => `
                                <div class="border-2 border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-bold text-lg">${month}</h4>
                                        <div class="text-right">
                                            <div class="text-sm text-slate-600">${monthlyStats[month].count}å› / ${monthlyStats[month].seats}å</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        ${Object.entries(monthlyStats[month].customers).map(([name, data]) => `
                                            <div class="text-sm p-2 ${customerColors[name]} rounded">
                                                <div class="font-bold">${name}</div>
                                                <div class="text-xs">${data.count}å› / ${data.seats}å</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadReservationCSV() {
            if (reservations.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let csv = 'äºˆç´„æ—¥,äºˆç´„è€…,äººæ•°,å‚™è€ƒ\n';
            
            reservations.sort((a, b) => a.date.localeCompare(b.date)).forEach(r => {
                csv += `"${r.date}","${r.name}","${r.seats}","${r.notes || ''}"\n`;
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            const today = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `ç¯‰åœ°è²å¾³_äºˆç´„ãƒ‡ãƒ¼ã‚¿_${today}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            return new Date(year, month, 1).getDay();
        }

        function formatDate(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function getReservationsForDate(dateStr) {
            return reservations.filter(r => r.date === dateStr);
        }

        function render() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);

            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            const canGoPrev = !(year === 2026 && month === 0);
            const canGoNext = !(year === 2026 && month === 11);

            let calendarHTML = '';
            let dayCounter = 1;

            for (let week = 0; week < 6; week++) {
                calendarHTML += '<div class="grid grid-cols-7 gap-1 md:gap-2">';
                
                for (let day = 0; day < 7; day++) {
                    const cellIndex = week * 7 + day;
                    
                    if (cellIndex < firstDay || dayCounter > daysInMonth) {
                        calendarHTML += '<div class="aspect-square"></div>';
                    } else {
                        const dateStr = formatDate(year, month, dayCounter);
                        const dayReservations = getReservationsForDate(dateStr);
                        const isToday = dateStr === new Date().toISOString().split('T')[0];
                        const hasReservations = dayReservations.length > 0;
                        
                        calendarHTML += `
                            <div class="relative bg-white rounded-lg shadow transition-all border-2 ${
                                isToday ? 'border-blue-500' : hasReservations ? 'border-green-400' : 'border-slate-200'
                            } ${hasReservations ? 'bg-green-50' : ''} hover:shadow-lg p-1 md:p-2">
                                <div class="text-xs md:text-sm font-bold mb-1 ${
                                    day === 0 ? 'text-red-600' : day === 6 ? 'text-blue-600' : 'text-slate-700'
                                }">
                                    ${dayCounter}
                                </div>
                                <div class="space-y-1 min-h-[40px] md:min-h-[60px]">
                                    ${dayReservations.map(r => `
                                        <div onclick="openReservationModal(null, ${JSON.stringify(r).replace(/"/g, '&quot;')})" 
                                            class="text-xs p-1 md:p-1.5 rounded border-2 cursor-pointer hover:opacity-80 ${customerColors[r.name]}">
                                            <div class="font-bold truncate">${r.name}</div>
                                            <div class="font-bold">${r.seats}å</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${dayReservations.length < 2 ? `
                                    <button onclick="openReservationModal('${dateStr}')" 
                                        class="w-full text-xs bg-blue-500 hover:bg-blue-600 text-white rounded py-1 mt-1 font-bold">
                                        +
                                    </button>
                                ` : ''}
                            </div>
                        `;
                        dayCounter++;
                    }
                }
                
                calendarHTML += '</div>';
                
                if (dayCounter > daysInMonth) break;
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">äºˆç´„ç®¡ç†</h1>
                                <p class="text-slate-600">ç¯‰åœ°è²å¾³ ãƒ‡ã‚£ãƒŠãƒ¼äºˆç´„ï¼ˆæœ€å¤§8å¸­ãƒ»2çµ„ã¾ã§ï¼‰</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="openAnalyticsModal()"
                                    class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg transition-colors">
                                    ğŸ“Š äºˆç´„åˆ†æ
                                </button>
                                <button onclick="openCustomerModal()"
                                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded-lg transition-colors">
                                    ğŸ‘¥ äºˆç´„è€…ç®¡ç†
                                </button>
                                <a href="index.html" 
                                    class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-4 py-2 rounded-lg transition-colors">
                                    â† ãƒˆãƒƒãƒ—ã¸
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <button onclick="changeMonth(-1)" 
                                ${!canGoPrev ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg transition-colors">
                                â† å‰æœˆ
                            </button>
                            <h2 class="text-xl md:text-3xl font-bold text-slate-800">
                                ${year}å¹´ ${monthNames[month]}
                            </h2>
                            <button onclick="changeMonth(1)" 
                                ${!canGoNext ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg transition-colors">
                                æ¬¡æœˆ â†’
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-2 md:p-4">
                        <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                            ${dayNames.map((name, i) => `
                                <div class="text-center font-bold text-xs md:text-sm ${i === 0 ? 'text-red-600' : i === 6 ? 'text-blue-600' : 'text-slate-700'}">
                                    ${name}
                                </div>
                            `).join('')}
                        </div>
                        ${calendarHTML}
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mt-6">
                        <h3 class="font-bold text-slate-800 mb-4">äºˆç´„è€…ã‚«ãƒ©ãƒ¼</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            ${customers.map(name => `
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded border-2 ${customerColors[name]}"></div>
                                    <span class="text-sm">${name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        window.openReservationModal = openReservationModal;
        window.closeReservationModal = closeReservationModal;
        window.saveReservation = saveReservation;
        window.deleteReservation = deleteReservation;
        window.changeMonth = changeMonth;
        window.openCustomerModal = openCustomerModal;
        window.closeCustomerModal = closeCustomerModal;
        window.addCustomer = addCustomer;
        window.deleteCustomer = deleteCustomer;
        window.openAnalyticsModal = openAnalyticsModal;
        window.closeAnalyticsModal = closeAnalyticsModal;
        window.downloadReservationCSV = downloadReservationCSV;

        (async () => {
            await initializeCustomers();
            await loadReservations();
            
            database.ref('reservations').on('value', async () => {
                await loadReservations();
                render();
            });
            
            database.ref('customers').on('value', async (snapshot) => {
                if (snapshot.exists()) {
                    customers = snapshot.val();
                    customers.forEach((name, index) => {
                        if (!customerColors[name]) {
                            customerColors[name] = COLOR_PALETTE[index % COLOR_PALETTE.length];
                        }
                    });
                    render();
                }
            });
            
            render();
        })();
    </script>
</body>
</html>
