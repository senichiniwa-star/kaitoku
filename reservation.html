<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁØâÂú∞Ë≤ùÂæ≥ ‰∫àÁ¥ÑÁÆ°ÁêÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="app" class="p-4 md:p-6"></div>

    <!-- ‰∫àÁ¥ÑËøΩÂä†/Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="reservationModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-8">
            <div class="flex items-center justify-between mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-slate-800">‰∫àÁ¥ÑËøΩÂä†</h2>
                <button onclick="closeReservationModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">‰∫àÁ¥ÑÊó•</label>
                    <input type="date" id="reservationDate" 
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">‰∫àÁ¥ÑËÄÖ</label>
                    <select id="reservationName" 
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">‰∫∫Êï∞</label>
                    <input type="number" id="reservationSeats" min="1" max="8" value="2"
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-slate-500 mt-1">‚ÄªÊúÄÂ§ß8Âêç„Åæ„Åß</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ</label>
                    <textarea id="reservationNotes" rows="3"
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="ÁâπË®ò‰∫ãÈ†Ö„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ"></textarea>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="saveReservation()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    ‰øùÂ≠ò
                </button>
                <button onclick="closeReservationModal()" 
                    class="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold py-3 rounded-lg transition-colors">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
            </div>
            
            <button id="deleteReservationButton" onclick="deleteReservation()" 
                class="w-full mt-3 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition-colors hidden">
                üóëÔ∏è „Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÂâäÈô§
            </button>
        </div>
    </div>

    <!-- ÊãÖÂΩì„Çπ„Çø„ÉÉ„ÉïË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="staffModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ÊãÖÂΩì„Çπ„Çø„ÉÉ„ÉïË®≠ÂÆö</h2>
                <button onclick="closeStaffModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Âñ∂Ê•≠Êó•</label>
                    <input type="text" id="staffDate" readonly
                        class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg bg-slate-100">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-4 border-2 border-blue-200 rounded-lg cursor-pointer hover:bg-blue-50">
                            <input type="radio" name="staff" value="‰ªô‰∏Ä" class="w-5 h-5 mr-3">
                            <span class="text-lg font-bold">‰ªô‰∏Ä</span>
                        </label>
                        <label class="flex items-center p-4 border-2 border-green-200 rounded-lg cursor-pointer hover:bg-green-50">
                            <input type="radio" name="staff" value="Âæ≥Â§öÈÉé" class="w-5 h-5 mr-3">
                            <span class="text-lg font-bold">Âæ≥Â§öÈÉé</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="saveStaff()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    Ë®≠ÂÆö
                </button>
                <button onclick="closeStaffModal()" 
                    class="flex-1 bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold py-3 rounded-lg transition-colors">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
            </div>
        </div>
    </div>

    <!-- ‰∫àÁ¥ÑËÄÖÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="customerModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">‰∫àÁ¥ÑËÄÖÁÆ°ÁêÜ</h2>
                <button onclick="closeCustomerModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                <h3 class="font-bold text-slate-700 mb-3">Êñ∞„Åó„ÅÑ‰∫àÁ¥ÑËÄÖ„ÇíËøΩÂä†</h3>
                <div class="flex gap-2">
                    <input type="text" id="newCustomerName" placeholder="‰∫àÁ¥ÑËÄÖÂêç"
                        class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <button onclick="addCustomer()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded-lg transition-colors">
                        ËøΩÂä†
                    </button>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-slate-700 mb-3">‰∫àÁ¥ÑËÄÖ„É™„Çπ„Éà</h3>
                <div id="customerList" class="space-y-2"></div>
            </div>

            <div class="mt-6">
                <button onclick="closeCustomerModal()"
                    class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition-colors">
                    Èñâ„Åò„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- ‰∫àÁ¥ÑÂàÜÊûê„É¢„Éº„ÉÄ„É´ -->
    <div id="analyticsModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800">‰∫àÁ¥ÑÁä∂Ê≥ÅÂàÜÊûê</h2>
                <button onclick="closeAnalyticsModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <div id="analyticsContent"></div>

            <div class="mt-6 flex gap-3">
                <button onclick="downloadReservationCSV()"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                    üì• CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </button>
                <button onclick="closeAnalyticsModal()"
                    class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition-colors">
                    Èñâ„Åò„Çã
                </button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuzBKMdD_2IQOWEMm9bK7bjEem3OTwrXE",
            authDomain: "kaitoku-32394.firebaseapp.com",
            databaseURL: "https://kaitoku-32394-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kaitoku-32394",
            storageBucket: "kaitoku-32394.firebasestorage.app",
            messagingSenderId: "166132839262",
            appId: "1:166132839262:web:128ce9ebe95b1c6bfa55cf"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const DEFAULT_CUSTOMERS = [
            'Ê§éÂêç', 'Ë±äÂúã', 'ÂëÇ', 'Âä†Ëó§', '‰∏πÁæΩ', 'Â∞èÊó©Â∑ù', 
            'Áü≥Áî∞', 'Á®ÆË∞∑', 'Â±±Êùë', 'Â§ßÂ≥∂', 'Ëµ§Â∑ù', 'Â∏ÇÂ†¥', '„Éû„Éº„ÇØ'
        ];

        const COLOR_PALETTE = [
            'bg-blue-100 border-blue-400 text-blue-900',
            'bg-green-100 border-green-400 text-green-900',
            'bg-purple-100 border-purple-400 text-purple-900',
            'bg-pink-100 border-pink-400 text-pink-900',
            'bg-yellow-100 border-yellow-400 text-yellow-900',
            'bg-indigo-100 border-indigo-400 text-indigo-900',
            'bg-red-100 border-red-400 text-red-900',
            'bg-orange-100 border-orange-400 text-orange-900',
            'bg-teal-100 border-teal-400 text-teal-900',
            'bg-cyan-100 border-cyan-400 text-cyan-900',
            'bg-lime-100 border-lime-400 text-lime-900',
            'bg-emerald-100 border-emerald-400 text-emerald-900',
            'bg-violet-100 border-violet-400 text-violet-900',
            'bg-fuchsia-100 border-fuchsia-400 text-fuchsia-900',
            'bg-rose-100 border-rose-400 text-rose-900',
            'bg-sky-100 border-sky-400 text-sky-900',
            'bg-amber-100 border-amber-400 text-amber-900'
        ];

        let reservations = [];
        let customers = [];
        let customerColors = {};
        let staffSchedule = {}; // Êó•‰ªò„Åî„Å®„ÅÆÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï
        let currentMonth = new Date(2026, 0, 1);
        let editingReservationId = null;
        let editingStaffDate = null;

        async function initializeCustomers() {
            try {
                const snapshot = await database.ref('customers').once('value');
                if (snapshot.exists()) {
                    customers = snapshot.val();
                } else {
                    customers = [...DEFAULT_CUSTOMERS];
                    await database.ref('customers').set(customers);
                }
                
                customers.forEach((name, index) => {
                    if (!customerColors[name]) {
                        customerColors[name] = COLOR_PALETTE[index % COLOR_PALETTE.length];
                    }
                });
            } catch (e) {
                console.error('‰∫àÁ¥ÑËÄÖ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
                customers = [...DEFAULT_CUSTOMERS];
            }
        }

        async function loadStaffSchedule() {
            try {
                const snapshot = await database.ref('staffSchedule').once('value');
                if (snapshot.exists()) {
                    staffSchedule = snapshot.val();
                } else {
                    staffSchedule = {};
                }
            } catch (e) {
                console.error('„Çπ„Çø„ÉÉ„Éï„Çπ„Ç±„Ç∏„É•„Éº„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }
        }

        async function addCustomer() {
            const input = document.getElementById('newCustomerName');
            const name = input.value.trim();
            
            if (!name) {
                alert('‰∫àÁ¥ÑËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (customers.includes(name)) {
                alert('Êó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã‰∫àÁ¥ÑËÄÖ„Åß„Åô');
                return;
            }
            
            customers.push(name);
            customerColors[name] = COLOR_PALETTE[customers.length % COLOR_PALETTE.length];
            await database.ref('customers').set(customers);
            input.value = '';
            renderCustomerModal();
            updateReservationNameSelect();
        }

        async function deleteCustomer(name) {
            if (confirm(`„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‚Äª„Åì„ÅÆ‰∫àÁ¥ÑËÄÖ„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅØÂâäÈô§„Åï„Çå„Åæ„Åõ„Çì`)) {
                customers = customers.filter(c => c !== name);
                delete customerColors[name];
                await database.ref('customers').set(customers);
                renderCustomerModal();
                updateReservationNameSelect();
            }
        }

        function openCustomerModal() {
            const modal = document.getElementById('customerModal');
            renderCustomerModal();
            modal.classList.add('show');
        }

        function closeCustomerModal() {
            const modal = document.getElementById('customerModal');
            modal.classList.remove('show');
        }

        function renderCustomerModal() {
            const list = document.getElementById('customerList');
            list.innerHTML = customers.map(name => `
                <div class="flex items-center justify-between p-3 ${customerColors[name]} rounded-lg border-2">
                    <span class="font-bold">${name}</span>
                    <button onclick="deleteCustomer('${name}')" 
                        class="text-red-600 hover:text-red-800 font-bold">
                        ÂâäÈô§
                    </button>
                </div>
            `).join('');
        }

        function updateReservationNameSelect() {
            const select = document.getElementById('reservationName');
            const currentValue = select.value;
            select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' + 
                customers.map(name => `<option value="${name}">${name}</option>`).join('');
            if (currentValue && customers.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        async function loadReservations() {
            try {
                const snapshot = await database.ref('reservations').once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    reservations = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                } else {
                    reservations = [];
                }
            } catch (e) {
                console.error('‰∫àÁ¥Ñ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }
        }

        function changeMonth(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            render();
        }

        function openStaffModal(date) {
            editingStaffDate = date;
            const modal = document.getElementById('staffModal');
            document.getElementById('staffDate').value = date;
            
            const currentStaff = staffSchedule[date];
            if (currentStaff) {
                document.querySelector(`input[name="staff"][value="${currentStaff}"]`).checked = true;
            } else {
                document.querySelectorAll('input[name="staff"]').forEach(r => r.checked = false);
            }
            
            modal.classList.add('show');
        }

        function closeStaffModal() {
            const modal = document.getElementById('staffModal');
            modal.classList.remove('show');
            editingStaffDate = null;
        }

        async function saveStaff() {
            const selected = document.querySelector('input[name="staff"]:checked');
            if (!selected) {
                alert('ÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            staffSchedule[editingStaffDate] = selected.value;
            await database.ref('staffSchedule').set(staffSchedule);
            closeStaffModal();
            render();
        }

        function openReservationModal(date = null, reservation = null) {
            const modal = document.getElementById('reservationModal');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteReservationButton');

            updateReservationNameSelect();

            if (reservation) {
                title.textContent = '‰∫àÁ¥ÑÁ∑®ÈõÜ';
                document.getElementById('reservationDate').value = reservation.date;
                document.getElementById('reservationName').value = reservation.name;
                document.getElementById('reservationSeats').value = reservation.seats;
                document.getElementById('reservationNotes').value = reservation.notes || '';
                deleteBtn.classList.remove('hidden');
                editingReservationId = reservation.id;
            } else {
                title.textContent = '‰∫àÁ¥ÑËøΩÂä†';
                document.getElementById('reservationDate').value = date || '';
                document.getElementById('reservationName').value = '';
                document.getElementById('reservationSeats').value = '2';
                document.getElementById('reservationNotes').value = '';
                deleteBtn.classList.add('hidden');
                editingReservationId = null;
            }

            modal.classList.add('show');
        }

        function closeReservationModal() {
            const modal = document.getElementById('reservationModal');
            modal.classList.remove('show');
            editingReservationId = null;
        }

        async function saveReservation() {
            const date = document.getElementById('reservationDate').value;
            const name = document.getElementById('reservationName').value;
            const seats = parseInt(document.getElementById('reservationSeats').value);
            const notes = document.getElementById('reservationNotes').value;

            if (!date || !name || !seats) {
                alert('Êó•‰ªò„ÄÅ‰∫àÁ¥ÑËÄÖ„ÄÅ‰∫∫Êï∞„ÅØÂøÖÈ†à„Åß„Åô');
                return;
            }

            const sameDay = reservations.filter(r => r.date === date && r.id !== editingReservationId);
            const totalSeats = sameDay.reduce((sum, r) => sum + r.seats, 0) + seats;
            
            if (sameDay.length >= 2) {
                alert('Âêå„ÅòÊó•„Å´ÊúÄÂ§ß2ÁµÑ„Åæ„Åß‰∫àÁ¥ÑÂèØËÉΩ„Åß„Åô');
                return;
            }
            
            if (totalSeats > 8) {
                alert(`Â∏≠Êï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºà‰ΩøÁî®ÂèØËÉΩ: ${8 - (totalSeats - seats)}Â∏≠Ôºâ`);
                return;
            }

            try {
                if (editingReservationId) {
                    await database.ref('reservations/' + editingReservationId).set({ date, name, seats, notes });
                } else {
                    const newRef = database.ref('reservations').push();
                    await newRef.set({ date, name, seats, notes });
                }
                
                await loadReservations();
                closeReservationModal();
                render();
            } catch (e) {
                console.error('‰∫àÁ¥Ñ‰øùÂ≠ò„Ç®„É©„Éº:', e);
                alert('‰∫àÁ¥Ñ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        async function deleteReservation() {
            if (!editingReservationId) return;
            
            if (confirm('„Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                try {
                    await database.ref('reservations/' + editingReservationId).remove();
                    await loadReservations();
                    closeReservationModal();
                    render();
                } catch (e) {
                    console.error('‰∫àÁ¥ÑÂâäÈô§„Ç®„É©„Éº:', e);
                    alert('‰∫àÁ¥Ñ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
        }

        function openAnalyticsModal() {
            const modal = document.getElementById('analyticsModal');
            renderAnalytics();
            modal.classList.add('show');
        }

        function closeAnalyticsModal() {
            const modal = document.getElementById('analyticsModal');
            modal.classList.remove('show');
        }

        function renderAnalytics() {
            const monthlyStats = {};
            const customerStats = {};
            
            reservations.forEach(r => {
                const month = r.date.substring(0, 7);
                
                if (!monthlyStats[month]) {
                    monthlyStats[month] = { count: 0, seats: 0, customers: {} };
                }
                monthlyStats[month].count++;
                monthlyStats[month].seats += r.seats;
                
                if (!monthlyStats[month].customers[r.name]) {
                    monthlyStats[month].customers[r.name] = { count: 0, seats: 0 };
                }
                monthlyStats[month].customers[r.name].count++;
                monthlyStats[month].customers[r.name].seats += r.seats;
                
                if (!customerStats[r.name]) {
                    customerStats[r.name] = { count: 0, seats: 0 };
                }
                customerStats[r.name].count++;
                customerStats[r.name].seats += r.seats;
            });

            const sortedMonths = Object.keys(monthlyStats).sort().reverse();
            const sortedCustomers = Object.entries(customerStats).sort((a, b) => b[1].count - a[1].count);

            const content = document.getElementById('analyticsContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-2">ÂÖ®‰Ωì„Çµ„Éû„É™„Éº</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-slate-600">Á∑è‰∫àÁ¥ÑÊï∞</div>
                                <div class="text-2xl font-bold text-blue-600">${reservations.length}‰ª∂</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-600">Á∑è‰∫∫Êï∞</div>
                                <div class="text-2xl font-bold text-blue-600">${reservations.reduce((sum, r) => sum + r.seats, 0)}Âêç</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-3">‰∫àÁ¥ÑËÄÖÂà•ÈõÜË®à</h3>
                        <div class="space-y-2">
                            ${sortedCustomers.map(([name, data]) => `
                                <div class="flex items-center justify-between p-3 ${customerColors[name]} rounded-lg border-2">
                                    <span class="font-bold">${name}</span>
                                    <div class="text-right">
                                        <div class="font-bold">${data.count}Âõû / ${data.seats}Âêç</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg mb-3">ÊúàÂà•ÈõÜË®à</h3>
                        <div class="space-y-4">
                            ${sortedMonths.map(month => `
                                <div class="border-2 border-slate-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-bold text-lg">${month}</h4>
                                        <div class="text-right">
                                            <div class="text-sm text-slate-600">${monthlyStats[month].count}Âõû / ${monthlyStats[month].seats}Âêç</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        ${Object.entries(monthlyStats[month].customers).map(([name, data]) => `
                                            <div class="text-sm p-2 ${customerColors[name]} rounded">
                                                <div class="font-bold">${name}</div>
                                                <div class="text-xs">${data.count}Âõû / ${data.seats}Âêç</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadReservationCSV() {
            if (reservations.length === 0) {
                alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã‰∫àÁ¥Ñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            let csv = '‰∫àÁ¥ÑÊó•,‰∫àÁ¥ÑËÄÖ,‰∫∫Êï∞,ÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï,ÂÇôËÄÉ\n';
            
            reservations.sort((a, b) => a.date.localeCompare(b.date)).forEach(r => {
                const staff = staffSchedule[r.date] || '';
                csv += `"${r.date}","${r.name}","${r.seats}","${staff}","${r.notes || ''}"\n`;
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            const today = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `ÁØâÂú∞Ë≤ùÂæ≥_‰∫àÁ¥Ñ„Éá„Éº„Çø_${today}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            return new Date(year, month, 1).getDay();
        }

        function formatDate(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function getReservationsForDate(dateStr) {
            return reservations.filter(r => r.date === dateStr);
        }

        function render() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);

            const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
            const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];

            const canGoPrev = !(year === 2026 && month === 0);
            const canGoNext = !(year === 2026 && month === 11);

            let calendarHTML = '';
            let dayCounter = 1;

            for (let week = 0; week < 6; week++) {
                calendarHTML += '<div class="grid grid-cols-7 gap-1 md:gap-2">';
                
                for (let day = 0; day < 7; day++) {
                    const cellIndex = week * 7 + day;
                    
                    if (cellIndex < firstDay || dayCounter > daysInMonth) {
                        calendarHTML += '<div class="aspect-square"></div>';
                    } else {
                        const dateStr = formatDate(year, month, dayCounter);
                        const dayReservations = getReservationsForDate(dateStr);
                        const isToday = dateStr === new Date().toISOString().split('T')[0];
                        const hasReservations = dayReservations.length > 0;
                        const staff = staffSchedule[dateStr];
                        
                        calendarHTML += `
                            <div class="relative bg-white rounded-lg shadow transition-all border-2 ${
                                isToday ? 'border-blue-500' : hasReservations ? 'border-green-400' : 'border-slate-200'
                            } ${hasReservations ? 'bg-green-50' : ''} hover:shadow-lg p-1 md:p-2">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="text-xs md:text-sm font-bold ${
                                        day === 0 ? 'text-red-600' : day === 6 ? 'text-blue-600' : 'text-slate-700'
                                    }">
                                        ${dayCounter}
                                    </div>
                                    ${staff ? `
                                        <button onclick="openStaffModal('${dateStr}')" 
                                            class="text-xs px-1 py-0.5 rounded ${
                                                staff === '‰ªô‰∏Ä' ? 'bg-blue-200 text-blue-800' : 'bg-green-200 text-green-800'
                                            } font-bold">
                                            ${staff}
                                        </button>
                                    ` : `
                                        <button onclick="openStaffModal('${dateStr}')" 
                                            class="text-xs px-1 py-0.5 rounded bg-slate-200 text-slate-600 hover:bg-slate-300">
                                            +
                                        </button>
                                    `}
                                </div>
                                <div class="space-y-1 min-h-[40px] md:min-h-[60px]">
                                    ${dayReservations.map(r => `
                                        <div onclick="openReservationModal(null, ${JSON.stringify(r).replace(/"/g, '&quot;')})" 
                                            class="text-xs p-1 md:p-1.5 rounded border-2 cursor-pointer hover:opacity-80 ${customerColors[r.name]}">
                                            <div class="font-bold truncate">${r.name}</div>
                                            <div class="font-bold">${r.seats}Âêç</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${dayReservations.length < 2 ? `
                                    <button onclick="openReservationModal('${dateStr}')" 
                                        class="w-full text-xs bg-blue-500 hover:bg-blue-600 text-white rounded py-1 mt-1 font-bold">
                                        +
                                    </button>
                                ` : ''}
                            </div>
                        `;
                        dayCounter++;
                    }
                }
                
                calendarHTML += '</div>';
                
                if (dayCounter > daysInMonth) break;
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">‰∫àÁ¥ÑÁÆ°ÁêÜ</h1>
                                <p class="text-slate-600">ÁØâÂú∞Ë≤ùÂæ≥ „Éá„Ç£„Éä„Éº‰∫àÁ¥ÑÔºàÊúÄÂ§ß8Â∏≠„Éª2ÁµÑ„Åæ„ÅßÔºâ</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="openAnalyticsModal()"
                                    class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg transition-colors">
                                    üìä ‰∫àÁ¥ÑÂàÜÊûê
                                </button>
                                <button onclick="openCustomerModal()"
                                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded-lg transition-colors">
                                    üë• ‰∫àÁ¥ÑËÄÖÁÆ°ÁêÜ
                                </button>
                                <a href="index.html" 
                                    class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-4 py-2 rounded-lg transition-colors">
                                    ‚Üê „Éà„ÉÉ„Éó„Å∏
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <button onclick="changeMonth(-1)" 
                                ${!canGoPrev ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg transition-colors">
                                ‚Üê ÂâçÊúà
                            </button>
                            <h2 class="text-xl md:text-3xl font-bold text-slate-800">
                                ${year}Âπ¥ ${monthNames[month]}
                            </h2>
                            <button onclick="changeMonth(1)" 
                                ${!canGoNext ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg transition-colors">
                                Ê¨°Êúà ‚Üí
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-2 md:p-4">
                        <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                            ${dayNames.map((name, i) => `
                                <div class="text-center font-bold text-xs md:text-sm ${i === 0 ? 'text-red-600' : i === 6 ? 'text-blue-600' : 'text-slate-700'}">
                                    ${name}
                                </div>
                            `).join('')}
                        </div>
                        ${calendarHTML}
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mt-6">
                        <h3 class="font-bold text-slate-800 mb-4">‰∫àÁ¥ÑËÄÖ„Ç´„É©„Éº / ÊãÖÂΩì„Çπ„Çø„ÉÉ„Éï</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="flex items-center gap-2 text-sm">
                                <div class="px-3 py-1 rounded bg-blue-200 text-blue-800 font-bold">‰ªô‰∏Ä</div>
                                <span>„Çπ„Çø„ÉÉ„Éï: ‰ªô‰∏Ä</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <div class="px-3 py-1 rounded bg-green-200 text-green-800 font-bold">Âæ≥Â§öÈÉé</div>
                                <span>„Çπ„Çø„ÉÉ„Éï: Âæ≥Â§öÈÉé</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            ${customers.map(name => `
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded border-2 ${customerColors[name]}"></div>
                                    <span class="text-sm">${name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        window.openReservationModal = openReservationModal;
        window.closeReservationModal = closeReservationModal;
        window.saveReservation = saveReservation;
        window.deleteReservation = deleteReservation;
        window.changeMonth = changeMonth;
        window.openCustomerModal = openCustomerModal;
        window.closeCustomerModal = closeCustomerModal;
        window.addCustomer = addCustomer;
        window.deleteCustomer = deleteCustomer;
        window.openAnalyticsModal = openAnalyticsModal;
        window.closeAnalyticsModal = closeAnalyticsModal;
        window.downloadReservationCSV = downloadReservationCSV;
        window.openStaffModal = openStaffModal;
        window.closeStaffModal = closeStaffModal;
        window.saveStaff = saveStaff;

        (async () => {
            await initializeCustomers();
            await loadStaffSchedule();
            await loadReservations();
            
            database.ref('reservations').on('value', async () => {
                await loadReservations();
                render();
            });
            
            database.ref('customers').on('value', async (snapshot) => {
                if (snapshot.exists()) {
                    customers = snapshot.val();
                    customers.forEach((name, index) => {
                        if (!customerColors[name]) {
                            customerColors[name] = COLOR_PALETTE[index % COLOR_PALETTE.length];
                        }
                    });
                    render();
                }
            });

            database.ref('staffSchedule').on('value', async (snapshot) => {
                if (snapshot.exists()) {
                    staffSchedule = snapshot.val();
                    render();
                }
            });
            
            render();
        })();
    </script>
</body>
</html>
